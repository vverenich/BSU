.MODEL SMALL
.CODE
JMP_OLD_HANDLER:
	JMP_COMMAND DB 0EAH
	JMP_OFFSET DW ?
	JMP_SEGMENT DW ?
	
NEW_HANDLER:
	CMP AH,30H
	JNE JMP_OLD_HANDLER
	MOV AX,050CH
	IRET
	
START:
	MOV AX,CS
	MOV DS,AX
	
	MOV AX,3521H
	INT 21H
	CMP BX,OFFSET NEW_HANDLER
	JE ALREADY_LOADED
	MOV CS:JMP_OFFSET,BX
	MOV CS:JMP_SEGMENT,ES
	
	MOV DX,OFFSET NEW_HANDLER
	MOV AX,2521H
	INT 21H
	
	MOV AH,62H
	INT 21H
	MOV DX,CS
	SUB DX,BX
	MOV AX,OFFSET START
	ADD AX,15
	MOV CL,4
	SHR AX,CL
	ADD DX,AX
	MOV AX,3100H
	INT 21H
	
ALREADY_LOADED:
	MOV DX,OFFSET ALREADY_LOADED_TEXT
	MOV AH,09H
	INT 21H
	MOV AX,4C00H
	INT 21H
	ALREADY_LOADED_TEXT DB 'The handler is already loaded!$'
END START
